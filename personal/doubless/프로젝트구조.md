# Doubless 피트니스 회원 및 급여 관리 시스템

## 📌 개요

Doubless 피트니스 센터의 회원 정보, 회원권, 수강권 데이터를 관리하고, 트레이너 급여를 분석하는 통합 관리 시스템입니다.

**주요 기능:**
- Broj CRM 시스템에서 회원 데이터 자동 다운로드 및 동기화
- SQLite 데이터베이스 기반 데이터 관리
- 트레이너 급여 지급 내역 분석 및 이상 케이스 탐지
- 월별 실적 리포트 자동 생성

---

## 📂 프로젝트 구조

```
doubless/
├── config.md                          # Broj CRM 로그인 정보 (필수)
├── 프로젝트구조.md                     # 이 파일
│
├── data/                              # 데이터베이스
│   ├── members.db                    # 회원/회원권/수강권 통합 DB
│   ├── salary.db                     # 트레이너 급여 DB
│   ├── backups/                      # DB 백업 폴더
│   └── README.md                     # DB 상세 설명
│
├── programs/                          # 실행 프로그램
│   ├── download_members.py           # Broj CRM 데이터 다운로드
│   ├── sync_to_db.py                 # JSON → DB 동기화
│   ├── create_new_db.py              # DB 스키마 생성
│   ├── monthly_salary_analysis.py    # 월별 급여 분석 (메인)
│   ├── salary_analysis.py            # 급여 이상 내역 체크
│   ├── analyze_all_trainers.py       # 전체 트레이너 분석
│   ├── venv/                         # Python 가상환경
│   └── README.md                     # 프로그램 사용법
│
├── pay/                               # 급여 관리
│   ├── 2025/                         # 연도별 급여 데이터
│   │   ├── 6월트레이너 급여 목포.xlsx
│   │   ├── 7월트레이너 급여 목포.xlsx
│   │   ├── 8월 트레이너 급여 목포.xlsx
│   │   ├── 9월 트레이너 급여 목포_수정본.xlsx
│   │   ├── 10월 트레이너 급여 목포.xlsx
│   │   └── 11월 트레이너 급여 목포.xlsx
│   └── report/                       # 분석 리포트
│       ├── YYYYMMDD_HHMMSS/         # 타임스탬프 폴더
│       │   ├── 2025년_N월_급여분석.txt (월별 리포트)
│       │   ├── 종합분석_*.txt
│       │   └── analysis_info.json
│       ├── latest/                   # 최신 분석 결과 (자동 업데이트)
│       └── analysis_history.json    # 전체 분석 이력
│
├── rule/                              # 규칙 및 문서
│   └── 급여내역테이블설명.md          # 급여 검증 규칙 및 DB 구조
│
└── 회원관리/                          # 회원 데이터
    ├── 동기화/                        # 동기화 데이터
    │   ├── YYYYMMDD_HHMMSS/         # 타임스탬프 폴더
    │   │   ├── members_sync_*.json
    │   │   ├── tickets_sync_*.json
    │   │   ├── lesson_tickets_sync_*.json
    │   │   └── sync_info.json
    │   ├── latest/                   # 최신 동기화 데이터 (자동 업데이트)
    │   ├── sync_history.json        # 동기화 이력
    │   └── doubless_broj_sync.md    # 동기화 시스템 설명
    ├── 수강권/                        # HTML 원본 (PT 수강권)
    ├── 회원권/                        # HTML 원본 (헬스 회원권)
    └── 확인필요항목/                  # 데이터 검증 메모
```

---

## 🔄 데이터 흐름

### 1. 회원 데이터 관리 흐름

```
Broj CRM API
    ↓
① download_members.py (데이터 다운로드)
    ↓
회원관리/동기화/YYYYMMDD_HHMMSS/*.json
    ↓
② sync_to_db.py (DB 동기화)
    ↓
data/members.db
    ↓
③ 분석 프로그램에서 활용
```

### 2. 급여 분석 흐름

```
엑셀 원본 (pay/2025/*.xlsx)
    ↓
① 수동 입력 → data/salary.db
    ↓
② monthly_salary_analysis.py (분석 실행)
    ↓
pay/report/YYYYMMDD_HHMMSS/
    ├── 월별 리포트 (N개)
    ├── 종합 리포트
    └── analysis_info.json
    ↓
pay/report/latest/ (자동 업데이트)
```

---

## 🚀 주요 작업 흐름

### 📥 회원 데이터 업데이트

```bash
# 1. Broj CRM에서 최신 데이터 다운로드
cd programs
./venv/bin/python3 download_members.py

# 결과:
# - 회원관리/동기화/YYYYMMDD_HHMMSS/ 폴더 생성
# - members, tickets, lesson_tickets JSON 파일
# - latest/ 폴더 자동 업데이트

# 2. DB 동기화
echo "yes" | ./venv/bin/python3 sync_to_db.py

# 결과:
# - data/members.db 업데이트
# - 1,042명 회원, 1,305건 회원권, 305건 수강권
```

### 📊 급여 분석 실행

```bash
# 월별 급여 분석 (메인)
cd programs
./venv/bin/python3 monthly_salary_analysis.py

# 결과:
# - pay/report/YYYYMMDD_HHMMSS/ 폴더 생성
# - 월별 리포트 6개 (6월~11월)
# - 종합 리포트 1개
# - latest/ 폴더 자동 업데이트
```

### 🔍 급여 이상 내역 체크

```bash
# 특정 트레이너 상세 분석
./venv/bin/python3 analyze_all_trainers.py

# 전체 급여 이상 내역
./venv/bin/python3 salary_analysis.py
```

---

## 📊 데이터베이스 구조

### members.db (회원 관리)

#### 1. members 테이블
- 회원 기본 정보 (1,042명)
- 주요 필드: jgjm_key (PK), 이름, 전화번호, 성별, 생년월일, 주소
- 상태: customer_status, classification
- 수강권: ticket_start, ticket_end, left_days

#### 2. tickets 테이블
- 회원권 정보 (1,305건)
- 주요 필드: jtd_key (PK), 회원권명, 시작일, 종료일
- 횟수: pass_origin_count, pass_count
- FK: jgjm_key → members

#### 3. lesson_tickets 테이블
- 수강권 정보 (305건, PT 등)
- 주요 필드: jglesson_ticket_key (PK), 수강권명, 트레이너
- 횟수: jglesson_ticket_origin_count, jglesson_ticket_count
- FK: jgjm_key → members

#### 4. sync_history 테이블
- 동기화 이력 추적
- sync_id, sync_time, 레코드 수, 성공 여부

### salary.db (급여 관리)

#### salary_records 테이블
- 트레이너 월별 급여 데이터 (2025년 6월~11월)
- 주요 필드:
  - 년도, 월, 트레이너, 회원명
  - 등록세션, 총진행세션, 남은세션
  - 당월진행세션, 당월수업료
  - 등록비용, 회단가, 이달의매출
- UNIQUE(년도, 월, 트레이너, 회원명)

---

## ✅ 급여 검증 규칙

### 규칙 1: 세션 수 일관성
```
이번달 남은세션 = 지난달 남은세션 - 이번달 진행세션
허용 오차: ±0.1
```

### 규칙 2: 잔여세션 증가 케이스
- **정상**: 이번달 등록세션 > 지난달 등록세션 (수강권 추가 구매)
- **이상**: 등록세션 불변 + 잔여세션 증가 → 확인 필요

### 규칙 3: PT 연결 끊김 처리
- 회원이 쉬다가 재등록하는 경우
- 수강권 재등록일자와 급여 발생월 비교

### 규칙 4: 회원권 만료 처리
- 회원권 만료 시 수업 진행 불가
- 갱신 여부 확인 필요

상세 내용: `rule/급여내역테이블설명.md` 참조

---

## 📋 이상 케이스 분류

### Type 1: 잔여증가+등록불변 ⚠️⚠️⚠️
가장 심각한 이상 케이스
- 원인: 수강권 추가 구매 미반영, 데이터 입력 오류
- 조치: lesson_tickets 테이블에서 구매 이력 확인

### Type 2: 잔여증가+등록증가 ✅
정상 케이스 (수강권 추가 구매)

### Type 3: 계산불일치 ⚠️
등록세션 불변, 계산 불일치
- 원인: 추가 세션 차감, 데이터 입력 오류
- 조치: 원본 엑셀 확인

---

## 🔧 환경 설정

### Python 가상환경

```bash
cd programs
python3 -m venv venv
source venv/bin/activate  # macOS/Linux
pip install -r requirements.txt
```

### 필수 라이브러리

- `sqlite3` (내장)
- `requests` - API 호출
- `beautifulsoup4` - HTML 파싱 (구버전 호환)
- `pathlib` (내장)
- `json` (내장)

### config.md 설정

```markdown
crm broj 사이트
url : https://crm.broj.co.kr/
id : your_id
pwd : your_password
```

⚠️ **중요**: `config.md`는 절대 Git에 커밋하지 마세요!

---

## 📁 폴더 관리 패턴

### 타임스탬프 폴더 방식

모든 중요 작업은 `YYYYMMDD_HHMMSS` 형식의 폴더로 관리:

**장점:**
- ✅ 이력 보존: 이전 분석/동기화 결과 유지
- ✅ 버전 관리: 데이터 변경 전후 비교 가능
- ✅ 롤백 가능: 문제 발생 시 이전 버전 참조

### latest 폴더

가장 최근 결과를 자동으로 복사:

**장점:**
- ✅ 빠른 접근: 폴더명 외울 필요 없음
- ✅ 자동화: 스크립트에서 항상 최신 데이터 참조
- ✅ 사용자 편의: 직관적인 접근

### 이력 파일 (JSON)

모든 실행 이력을 JSON으로 기록:

- `회원관리/동기화/sync_history.json`
- `pay/report/analysis_history.json`

**장점:**
- ✅ 추적 가능: 언제, 무엇을, 얼마나 처리했는지 기록
- ✅ 프로그래밍 접근: JSON 파싱으로 통계 생성 가능
- ✅ 추세 분석: 시계열 데이터로 트렌드 파악

---

## 🎯 주요 분석 지표

### 월별 급여 분석 (2025년 6~11월)

| 월 | 트레이너 | 회원수 | 세션수 | 총급여(원) | 이상건수 |
|----|----------|--------|--------|------------|----------|
| 6월 | 3 | 92 | 398 | 6,517,200 | 0건 |
| 7월 | 3 | 84 | 395 | 7,715,000 | 28건 |
| 8월 | 5 | 90 | 444 | 8,694,007 | 25건 |
| 9월 | 5 | 76 | 396 | 8,150,002 | 16건 |
| 10월 | 5 | 83 | 350 | 6,852,005 | 22건 |
| 11월 | 4 | 88 | 375 | 6,725,405 | 23건 |
| **합계** | - | - | **2,358** | **44,653,619** | **114건** |

**월 평균 지급액**: 7,442,270원

---

## 📚 문서 참조

### 시스템 설명
- `프로젝트구조.md` (이 파일) - 전체 프로젝트 구조 및 사용법
- `회원관리/동기화/doubless_broj_sync.md` - 회원 동기화 상세 설명
- `rule/급여내역테이블설명.md` - 급여 검증 규칙 및 DB 구조

### 프로그램 사용법
- `programs/README.md` - 각 프로그램 상세 설명
- `data/README.md` - 데이터베이스 스키마 및 관계

---

## 🔒 보안 주의사항

### 민감 정보 관리

**절대 Git에 커밋 금지:**
- ❌ `config.md` (로그인 정보)
- ❌ `*.db` (개인정보 포함)
- ❌ `*.xlsx` (급여 정보)
- ❌ `회원관리/동기화/**/*.json` (회원 데이터)

**백업 관리:**
- ✅ `data/backups/` 폴더에 자동 백업
- ✅ 중요한 변경 전 수동 백업 권장

---

## 📞 문제 해결

### 자주 발생하는 문제

#### 1. 로그인 실패
```
❌ 로그인 실패: 토큰을 찾을 수 없습니다.
```
**해결**: `config.md`의 ID/PW 확인, 네트워크 연결 확인

#### 2. DB 동기화 실패
```
❌ 동기화 실패: table has no column named ...
```
**해결**: `create_new_db.py` 재실행하여 스키마 재생성

#### 3. 분석 결과 없음
```
⚠️ 분석 가능한 데이터가 없습니다.
```
**해결**: `data/salary.db`에 급여 데이터 확인

---

## 🔄 버전 이력

### 2025-12-26
- 월별 급여 분석 시스템 개선
  - 타임스탬프 폴더 구조 도입
  - 월별 개별 리포트 생성
  - latest 폴더 자동 업데이트
  - 메타데이터 관리 (JSON)

- DB 스키마 재설계
  - JSON 필드명 직접 매핑
  - 외래키 관계 설정
  - sync_id를 통한 데이터 lineage 추적

- 회원 동기화 시스템 구축
  - Broj CRM API 연동
  - 폴더 기반 동기화 관리
  - 자동 이력 추적

- 문서 체계화
  - 급여내역테이블설명.md 상세화
  - 프로젝트구조.md 작성
  - 중복 문서 정리

---

## 📄 라이선스

이 프로젝트는 Doubless 피트니스 센터 내부 사용을 위한 것입니다.

---

## ✨ 개선 계획

- [ ] 웹 대시보드 개발 (Flask/Django)
- [ ] 자동 알림 시스템 (이상 케이스 발생 시)
- [ ] 트레이너별 실적 대시보드
- [ ] 월 마감 자동화
- [ ] 회원권 만료 알림
