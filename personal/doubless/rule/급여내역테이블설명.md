# 급여 내역 테이블 설명 및 검증 규칙

## 📊 테이블 구조

### salary_records 테이블

```sql
CREATE TABLE salary_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    년도 INTEGER NOT NULL,
    월 TEXT NOT NULL,
    트레이너 TEXT NOT NULL,
    NO INTEGER,
    회원명 TEXT NOT NULL,
    성별 TEXT,
    등록세션 REAL,              -- 수강권 총 등록 세션 수
    총진행세션 REAL,            -- 누적 진행 세션 수
    남은세션 REAL,              -- 현재 남은 세션 수
    결제형태 TEXT,
    등록비용 REAL,
    공급가 REAL,
    회단가 REAL,
    매출대비율 REAL,
    수업료_정산 REAL,
    당월진행세션 REAL,          -- 해당 월에 진행한 세션 수
    당월수업료 REAL,            -- 해당 월 트레이너 급여
    이달의매출 REAL,            -- 해당 월 발생 매출
    등록일시 TEXT DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(년도, 월, 트레이너, 회원명)
);
```

## 🔍 주요 필드 설명

### 세션 관련 필드

| 필드명 | 설명 | 예시 |
|--------|------|------|
| **등록세션** | 회원이 수강권 구매 시 등록한 총 세션 수 | 50회권 구매 → 50 |
| **총진행세션** | 수강권 시작 ~ 현재까지 누적 진행 세션 | 30회 진행 → 30 |
| **남은세션** | 현재 시점에서 남은 세션 수 | 등록 50 - 진행 30 = 20 |
| **당월진행세션** | 해당 월에 진행한 세션 수 | 9월에 8회 진행 → 8 |

### 금액 관련 필드

| 필드명 | 설명 | 계산 방식 |
|--------|------|-----------|
| **등록비용** | 회원이 지불한 수강권 금액 | 회원 결제 금액 |
| **회단가** | 세션 1회당 단가 | 등록비용 ÷ 등록세션 |
| **당월수업료** | 해당 월 트레이너가 받을 급여 | 당월진행세션 × 회단가 × 매출대비율 |
| **이달의매출** | 해당 월 발생한 매출 | 당월진행세션 × 회단가 |

## ✅ 데이터 검증 규칙

### 규칙 1: 세션 수 일관성 검증

**기본 공식:**
```
이번달 남은세션 = 지난달 남은세션 - 이번달 진행세션
```

**예시:**
- 8월 남은세션: 50회
- 9월 진행세션: 8회
- 9월 남은세션: 50 - 8 = 42회 ✅

**허용 오차:** ±0.1 (소수점 계산 오차)

### 규칙 2: 잔여세션 증가 케이스

잔여세션이 증가하는 경우는 다음 조건을 만족해야 합니다:

1. **정상 케이스: 수강권 추가 구매**
   - 조건: `이번달 등록세션 > 지난달 등록세션`
   - 예시:
     ```
     8월: 등록세션 50, 남은세션 42
     9월: 등록세션 100 (+50), 남은세션 92 (42 + 50)
     → ✅ 수강권 50회 추가 구매
     ```

2. **⚠️ 이상 케이스: 등록세션 불변 + 잔여세션 증가**
   - 조건: `이번달 등록세션 = 지난달 등록세션` AND `이번달 남은세션 > 지난달 남은세션`
   - 원인:
     - 데이터 입력 오류
     - 수강권 정보 누락
     - 세션 차감 누락
   - 조치: 수강권 구매 내역 확인 필요

### 규칙 3: PT 연결 끊김 처리

회원이 쉬다가 다시 등록하는 경우:

1. **이전 수강권 종료**
   - 남은세션: 0
   - 상태: 종료

2. **신규 수강권 등록**
   - 새로운 등록세션으로 시작
   - 발생월과 수강권 재등록일자 비교 확인

**확인 방법:**
```sql
SELECT
    jgjm_member_name,
    jglesson_ticket_type,
    datetime(jglesson_ticket_started_dttm/1000, 'unixepoch', 'localtime') as 시작일,
    jglesson_ticket_origin_count as 원본횟수
FROM lesson_tickets
WHERE jgjm_member_name = '회원명'
ORDER BY jglesson_ticket_started_dttm;
```

### 규칙 4: 회원권 만료 처리

회원권이 이번달에 만료되는 경우:

- 더 이상 수업 진행 불가
- 남은세션이 있어도 수업료 미발생
- 회원권 갱신 확인 필요

**확인 방법:**
```sql
SELECT
    jgjm_member_name,
    jtd_name,
    datetime(jtd_closed_dttm/1000, 'unixepoch', 'localtime') as 종료일,
    ticket_status
FROM tickets
WHERE jgjm_member_name = '회원명'
ORDER BY jtd_closed_dttm DESC;
```

## 📋 이상 케이스 분류

### Type 1: 잔여세션 증가 + 등록세션 불변 ⚠️⚠️⚠️

**가장 심각한 이상 케이스**

```
예시:
8월: 등록세션 50, 남은세션 42, 진행세션 8
9월: 등록세션 50, 남은세션 45, 진행세션 5

계산: 42 - 5 = 37 (예상)
실제: 45 (차이 +8)

→ 수강권 추가 구매 확인 필요
```

**확인 사항:**
- lesson_tickets 테이블에서 해당 회원의 수강권 구매 이력
- 수강권 시작일과 이상 발생월 비교
- 누락된 수강권 정보 추가

### Type 2: 잔여세션 증가 + 등록세션 증가 ✅

**정상 케이스 (수강권 추가 구매)**

```
예시:
8월: 등록세션 50, 남은세션 42, 진행세션 8
9월: 등록세션 100, 남은세션 92, 진행세션 8

계산: 42 - 8 = 34 (예상)
실제: 92 (차이 +58)
등록세션 증가: +50

→ 정상 (수강권 50회 추가)
```

### Type 3: 계산 불일치 ⚠️

**등록세션 불변, 계산 불일치**

```
예시:
8월: 등록세션 50, 남은세션 42, 진행세션 8
9월: 등록세션 50, 남은세션 30, 진행세션 8

계산: 42 - 8 = 34 (예상)
실제: 30 (차이 -4)

→ 데이터 입력 오류 또는 추가 세션 차감 확인 필요
```

## 🔧 검증 프로그램

### 월별 급여 분석

```bash
# 전체 월별 분석
venv/bin/python3 programs/monthly_salary_analysis.py

# 특정 트레이너 분석
venv/bin/python3 programs/analyze_all_trainers.py
```

### 급여 이상 내역 체크

```bash
# 급여 지급 분석 및 이상 내역
venv/bin/python3 programs/salary_analysis.py
```

## 📊 분석 보고서 항목

### 1. 월별 전체 개요
- 트레이너 수
- 회원 수
- 총 진행 세션
- 총 수업료 (급여)
- 총 매출
- 평균 수업료

### 2. 월별 트레이너 실적
- 담당 회원 수
- 진행 세션 수
- 총 수업료
- 평균 수업료
- 평균 진행 세션

### 3. 세션 이상 케이스
- Type별 분류 및 건수
- 회원별 상세 내역
- 예상값 vs 실제값 비교

### 4. 트레이너별 통계
- 월별 실적 추이
- 이상 케이스 발생 건수
- 평균 급여

## 💡 데이터 연계

### salary_records ↔ lesson_tickets

```sql
-- 급여 데이터의 회원이 실제 수강권을 가지고 있는지 확인
SELECT
    s.회원명,
    s.월,
    s.등록세션,
    s.남은세션,
    l.jglesson_ticket_type,
    l.jglesson_ticket_origin_count,
    l.jglesson_ticket_count
FROM salary_records s
LEFT JOIN lesson_tickets l ON s.회원명 = l.jgjm_member_name
WHERE s.년도 = 2025 AND s.월 = '11월'
ORDER BY s.회원명;
```

### salary_records ↔ tickets (회원권)

```sql
-- 회원권 만료 확인
SELECT
    s.회원명,
    s.월,
    s.당월진행세션,
    t.jtd_name,
    datetime(t.jtd_closed_dttm/1000, 'unixepoch', 'localtime') as 회원권종료일,
    t.ticket_status
FROM salary_records s
LEFT JOIN tickets t ON s.회원명 = t.jgjm_member_name
WHERE s.년도 = 2025 AND s.월 = '11월'
  AND t.jtd_closed_dttm/1000 < strftime('%s', 'now')
ORDER BY s.회원명;
```

## 📝 데이터 관리 지침

### 1. 월별 데이터 입력 시

- [ ] 모든 트레이너의 담당 회원 포함 확인
- [ ] 당월진행세션이 0이 아닌 회원만 입력
- [ ] 등록세션, 총진행세션, 남은세션 일관성 확인
- [ ] 수강권 추가 구매 시 등록세션 업데이트

### 2. 데이터 검증

- [ ] 규칙 1: 세션 수 일관성 (자동 검증)
- [ ] 규칙 2: 잔여세션 증가 시 등록세션 확인
- [ ] 규칙 3: PT 연결 끊김 확인
- [ ] 규칙 4: 회원권 만료 확인

### 3. 이상 케이스 발견 시

1. Type 1 (잔여증가+등록불변)
   - lesson_tickets에서 수강권 구매 이력 확인
   - 누락된 등록세션 정보 업데이트

2. Type 3 (계산불일치)
   - 해당 월 엑셀 원본 데이터 확인
   - 추가 세션 차감 사유 확인
   - 데이터 수정 또는 사유 기록

## 🔄 업데이트 이력

- **2025-12-26**: 테이블 구조 및 검증 규칙 상세화
  - 주요 필드 설명 추가
  - 이상 케이스 분류 체계화 (Type 1/2/3)
  - 데이터 연계 쿼리 추가
  - lesson_tickets, tickets 테이블 연계 방법 추가
  - 월별 분석 프로그램 추가

- **초기 버전**: 기본 검증 규칙 정의
  - 세션 수 일관성 검증
  - 잔여세션 증가 케이스
  - PT 연결 끊김 처리
  - 회원권 만료 처리
